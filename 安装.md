
先构建环境 我用了 vagrant ，会多一些步骤，没有的话直接在虚拟机上安装也行。

###### vagrant
~~~bash
  config.vm.box = "generic/ubuntu1804"
  config.vm.box_version = "1"
  config.vm.network "forwarded_port", guest: 9090, host: 9090
  config.vm.network "forwarded_port", guest: 9093, host: 9093
  config.vm.network "forwarded_port", guest: 3000, host: 3000
  config.vm.synced_folder ".", "/vagrant" ##, disabled: true
  config.vm.network "public_network", bridge: "wlp3s0",adapter: 2, auto_config: false
~~~

用途分别是把几个端口映射出来，及打开公有网络
画一下访问路径：
pc - > server -> vargrant -> app:port

另外，如果不同可能是防火墙问题


```bash
/sbin/iptables -I INPUT -p tcp --dport 8000 -j ACCEPT
/sbin/iptables -I INPUT -p tcp --dport 9090 -j ACCEPT
/sbin/iptables -I INPUT -p tcp --dport 9093 -j ACCEPT
/sbin/iptables -I INPUT -p tcp --dport 3000 -j ACCEPT
```



###### docker安装

这边用的是 snap 安装，后面会有个小插曲，遇到再说

```bash
sudo snap install docker
docker-compose version
# Docker Compose version v2.17.2
```
很神奇 docker-compose 也装好了，省了很多事



##### 组件及端口

prometheus：

- prometheus 9090
- alertmanager 9093
- cadvisor 8080
- node_exporter 9100
- grafana 3000

###### docker-compose 基础

```bash
sudo docker rm $(sudo docker ps -a -q)
touch docker-compose.yaml
# 下面多次编辑并使用，调试
vi !$
sudo docker-compose up
```



docker-compose.yaml 架构

- version: '3.3'
- volumes:
  - prometheus_data: {}
- networks:
  - monitoring:
    - driver: bridge
- services：
  - prometheus：



docker-compose.yaml 的基础架构如上，先有版本，然后定义volumes（存储空间），networks（网络），services （各应用都在服务里）



###### prometheus

- prometheus:
  - image: prom/prometheus:v2.37.6  镜像（最重要）
  - container_name: prometheus  名字
  - restart: always  启动方式
  - volumes:  挂载相关 （3种主要的挂载方式， 宿主:容器）
    - /etc/localtime:/etc/localtime:ro    时区
    - ./prometheus/:/etc/prometheus/  项目同目录
    - prometheus_data:/prometheus  随机目录，保存应用信息，上节 volumes 段定义过
  - command:
    - '应用启动的参数，很多都时厂商定义好的'
    - #- '--web.enable-admin-api'   （参数中间，注释也是可以起作用的）
  - networks:
    - monitoring  上节 networks 段定义过
  - links:
    - 多个容器间的关联，目前没有，不要写
  - expose:
    - '9090'   暴露端口，访问测试用的
  - ports:
    - 9090:9090  映射端口，宿主机，容器
  - depends_on:
    - 目前没有



写好了运行一下

```bash
sudo docker-compose up
# prometheus  | ts=2023-10-15T06:14:40.654Z caller=main.go:450 level=error msg="Error loading config (--config.file=/etc/prometheus/prometheus.yml)" file=/etc/prometheus/prometheus.yml err="open /etc/prometheus/prometheus.yml: no such file or directory"  没有配置文件

sudo mkdir prometheus
sudo touch prometheus/prometheus.yml
```



看下配置的内容

```yaml
global:
  scrape_interval:     20s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'prometheus'
    scrape_interval: 15s
    static_configs:
    - targets: ['localhost:9090']
```

设定全局拉取时间，并建立一个job 监控自己


  
